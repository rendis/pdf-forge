// Code generated by pdfforge-cli init for project "{{.ProjectName}}".
// pdf-forge: https://github.com/rendis/pdf-forge

package extensions

import (
	"log/slog"
	"time"

	"github.com/gin-gonic/gin"
)

// =============================================================================
// GLOBAL MIDDLEWARE
// Applied to ALL routes (health, swagger, api, internal).
// Execution order: Recovery → Logger → CORS → [Your Middleware] → Routes
// Register with: engine.UseMiddleware(middleware)
// =============================================================================

// RequestLoggerMiddleware logs request latency and status.
func RequestLoggerMiddleware() gin.HandlerFunc {
	return func(c *gin.Context) {
		start := time.Now()
		path := c.Request.URL.Path
		method := c.Request.Method

		c.Next()

		slog.InfoContext(c.Request.Context(), "http request",
			slog.String("method", method),
			slog.String("path", path),
			slog.Int("status", c.Writer.Status()),
			slog.Duration("latency", time.Since(start)),
			slog.String("client_ip", c.ClientIP()))
	}
}

// CustomHeadersMiddleware adds custom response headers.
func CustomHeadersMiddleware() gin.HandlerFunc {
	return func(c *gin.Context) {
		c.Header("X-Powered-By", "pdf-forge")
		c.Next()
	}
}

// =============================================================================
// API MIDDLEWARE
// Applied to /api/v1/* routes only, AFTER authentication.
// Execution order: Operation → Auth → Identity → Roles → [Your Middleware] → Controller
// At this point, you can access authenticated user context:
//   - c.Get("user_id")      → internal user ID
//   - c.Get("user_email")   → user email
//   - c.Get("tenant_id")    → tenant ID (from X-Tenant-ID header)
//   - c.Get("workspace_id") → workspace ID (from X-Workspace-ID header)
// Register with: engine.UseAPIMiddleware(middleware)
// =============================================================================

// TenantValidationMiddleware validates tenant access.
// Runs after authentication, so user context is available.
func TenantValidationMiddleware() gin.HandlerFunc {
	return func(c *gin.Context) {
		// Example: Log the authenticated user and tenant
		// userID, _ := c.Get("user_id")
		// tenantID := c.GetHeader("X-Tenant-ID")
		// slog.InfoContext(c.Request.Context(), "tenant access",
		//     slog.Any("user_id", userID),
		//     slog.String("tenant_id", tenantID))

		c.Next()
	}
}

// RateLimitMiddleware is a placeholder for rate limiting logic.
// In production, use golang.org/x/time/rate or similar.
func RateLimitMiddleware(requestsPerSecond int) gin.HandlerFunc {
	return func(c *gin.Context) {
		// Rate limit logic here
		c.Next()
	}
}
