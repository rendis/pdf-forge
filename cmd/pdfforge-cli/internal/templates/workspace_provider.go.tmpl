package extensions

import (
	"context"
	"fmt"

	"github.com/rendis/pdf-forge/sdk"
)

// ExampleWorkspaceProvider demonstrates dynamic injectables per workspace.
// These injectables are loaded at runtime (when editor opens), not from YAML.
//
// i18n: Return all locales in map[string]string. The framework picks the right
// one based on the request locale. Fallback order: requested locale → "en" → code.
type ExampleWorkspaceProvider struct{}

// GetInjectables returns available injectables for a workspace.
// Called when the template editor opens. Return all locales.
func (p *ExampleWorkspaceProvider) GetInjectables(ctx context.Context, req *sdk.GetInjectablesRequest) (*sdk.GetInjectablesResult, error) {
	return &sdk.GetInjectablesResult{
		Injectables: []sdk.ProviderInjectable{
			{
				Code: "customer_name",
				Label: map[string]string{
					"es": "Nombre del Cliente",
					"en": "Customer Name",
				},
				Description: map[string]string{
					"es": "Nombre completo del cliente",
					"en": "Full customer name",
				},
				DataType: sdk.InjectableDataTypeText,
				GroupKey: "custom_data",
			},
			{
				Code: "order_total",
				Label: map[string]string{
					"es": "Total del Pedido",
					"en": "Order Total",
				},
				Description: map[string]string{
					"es": "Monto total del pedido",
					"en": "Total order amount",
				},
				DataType: sdk.InjectableDataTypeNumber,
				GroupKey: "custom_data",
				Formats: []sdk.ProviderFormat{
					{Key: "#,##0.00", Label: map[string]string{"es": "1.234,56", "en": "1,234.56"}},
					{Key: "$#,##0.00", Label: map[string]string{"es": "$1.234,56", "en": "$1,234.56"}},
				},
			},
		},
		Groups: []sdk.ProviderGroup{
			{
				Key: "custom_data",
				Name: map[string]string{
					"es": "Datos Personalizados",
					"en": "Custom Data",
				},
				Icon: "database",
			},
		},
	}, nil
}

// ResolveInjectables resolves injectable values during render.
// Called when a template is rendered and contains workspace-specific injectables.
func (p *ExampleWorkspaceProvider) ResolveInjectables(ctx context.Context, req *sdk.ResolveInjectablesRequest) (*sdk.ResolveInjectablesResult, error) {
	values := make(map[string]*sdk.InjectableValue)
	errors := make(map[string]string)

	for _, code := range req.Codes {
		switch code {
		case "customer_name":
			// In real usage: fetch from req.Payload, req.Headers, or external API
			val := sdk.StringValue("John Doe")
			values[code] = &val

		case "order_total":
			// req.SelectedFormats[code] contains the user-selected format key
			val := sdk.NumberValue(1234.56)
			values[code] = &val

		default:
			// Unknown code - non-critical error (render continues with default)
			errors[code] = fmt.Sprintf("unknown injectable: %s", code)
		}
	}

	return &sdk.ResolveInjectablesResult{
		Values: values,
		Errors: errors, // Non-critical errors. For critical: return nil, err
	}, nil
}
