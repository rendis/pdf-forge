# Stage 1: Build frontend from pdf-forge source
FROM node:22-alpine AS frontend
RUN apk add --no-cache git
ARG PDF_FORGE_VERSION=main
ARG BASE_PATH=
RUN git clone --depth 1 --branch ${PDF_FORGE_VERSION} https://github.com/rendis/pdf-forge.git /pdf-forge
WORKDIR /pdf-forge/app
RUN npm install -g pnpm && pnpm install --frozen-lockfile && VITE_BASE_PATH=${BASE_PATH} pnpm build

# Stage 2: Build Go binary with embedded frontend
FROM golang:1.25-alpine AS build
WORKDIR /src
COPY go.mod go.sum ./
RUN go mod download
COPY . .
COPY --from=frontend /pdf-forge/app/dist ./frontend-dist/
RUN CGO_ENABLED=0 go build -o /bin/server .

# Stage 3: Runtime
FROM alpine:3.21
RUN apk add --no-cache ca-certificates typst
COPY --from=build /bin/server /bin/server
COPY settings/ /app/settings/
WORKDIR /app
EXPOSE 8080
CMD ["/bin/server"]
