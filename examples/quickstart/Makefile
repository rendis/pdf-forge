# Generated by pdfforge-cli init for project "examples/quickstart".
# pdf-forge: https://github.com/rendis/pdf-forge

.PHONY: fresh check up up-db down build run migrate logs clean dev test fmt lint help run-script

# Environment file selection
# Usage: make run ENV=.env.prod  (skip prompt, load specific file)
#        make run                (auto-select or prompt if multiple)
ENV ?=

# Resolve .env file: ENV flag > single file > prompt
ENVFILES := $(wildcard .env .env.*)
ENVFILES := $(filter-out %.example,$(ENVFILES))

ifdef ENV
  SELECTED_ENV := $(ENV)
else ifeq ($(words $(ENVFILES)),1)
  SELECTED_ENV := $(ENVFILES)
else ifeq ($(words $(ENVFILES)),0)
  SELECTED_ENV :=
else
  # Multiple files - will prompt at runtime
  SELECTED_ENV := __prompt__
endif

# Export selected env file
ifneq ($(SELECTED_ENV),)
ifneq ($(SELECTED_ENV),__prompt__)
  -include $(SELECTED_ENV)
  export
endif
endif

define prompt_env
@if [ "$(SELECTED_ENV)" = "__prompt__" ]; then \
  echo "Multiple .env files found:"; \
  files=($(ENVFILES)); \
  i=1; for f in $${files[@]}; do echo "  $$i) $$f"; i=$$((i+1)); done; \
  echo "  $$i) Skip (use defaults)"; \
  read -p "Select [1-$$i]: " choice; \
  if [ "$$choice" -lt "$$i" ] 2>/dev/null; then \
    set -a && . ./$${files[$$((choice-1))]} && set +a; \
    echo "» Loaded $${files[$$((choice-1))]}"; \
  fi; \
elif [ -n "$(SELECTED_ENV)" ]; then \
  echo "» Loaded $(SELECTED_ENV)"; \
fi
endef

# PostgreSQL port (override via PG_PORT=5433 make up-db or in .env)
PG_PORT ?= 5432

## fresh: Full reset — clean DB, start PG, build and run (recommended for first run)
fresh: check clean up-db _wait-pg build
	$(call prompt_env)
	@echo "» Starting app on http://localhost:8080"
	@./bin/app

## check: Verify prerequisites (Docker, Typst, Go)
check:
	@echo "» Checking prerequisites..."
	@command -v docker >/dev/null 2>&1 || { echo "  ✗ Docker not found — install from https://docs.docker.com/get-docker/"; exit 1; }
	@command -v typst >/dev/null 2>&1 || { echo "  ✗ Typst not found — install: brew install typst (macOS) or cargo install typst-cli"; exit 1; }
	@command -v go >/dev/null 2>&1 || { echo "  ✗ Go not found — install from https://go.dev/dl/"; exit 1; }
	@echo "  ✓ All OK"

_wait-pg:
	@printf "» Waiting for PostgreSQL"
	@for i in 1 2 3 4 5 6 7 8 9 10; do \
	  docker exec $$(docker compose ps -q postgres 2>/dev/null) pg_isready -U postgres >/dev/null 2>&1 && printf " ready\n" && exit 0 || printf "." && sleep 1; \
	done; echo " timeout (check docker logs)" && exit 1

## up: Start app + PostgreSQL (full containerized)
up:
	@echo "» PostgreSQL port: $(PG_PORT)"
	PG_PORT=$(PG_PORT) docker compose up --build -d

## up-db: Start only PostgreSQL
up-db:
	@echo "» PostgreSQL port: $(PG_PORT)"
	PG_PORT=$(PG_PORT) docker compose up postgres -d

## down: Stop all containers
down:
	docker compose down

## logs: Tail container logs
logs:
	docker compose logs -f

## clean: Stop containers, remove volumes
clean:
	docker compose down -v

# Local development

## build: Build the Go binary
build:
	go build -o bin/app .

## run: Build and run locally (requires PG running)
run: build
	$(call prompt_env)
	./bin/app

## migrate: Apply database migrations
migrate:
	@command -v pdfforge-cli >/dev/null 2>&1 && pdfforge-cli migrate || go run github.com/rendis/pdf-forge/cmd/pdfforge-cli migrate

## dev: Run with hot reload (requires air: go install github.com/air-verse/air@latest)
dev:
	$(call prompt_env)
	air

## test: Run tests
test:
	$(call prompt_env)
	go test -race ./...

## fmt: Format Go source files
fmt:
	gofmt -w .

## lint: Run linter (requires golangci-lint)
lint:
	golangci-lint run ./...

# Scripts (uses pdfforge-cli for interactive selection)
ifeq (run-script,$(firstword $(MAKECMDGOALS)))
  SCRIPT_NAME := $(wordlist 2,$(words $(MAKECMDGOALS)),$(MAKECMDGOALS))
  $(eval $(SCRIPT_NAME):;@:)
endif

## run-script: Run a script (usage: make run-script [name])
run-script:
ifdef SCRIPT_NAME
	@command -v pdfforge-cli >/dev/null 2>&1 && pdfforge-cli run-script $(SCRIPT_NAME) || go run github.com/rendis/pdf-forge/cmd/pdfforge-cli run-script $(SCRIPT_NAME)
else
	@command -v pdfforge-cli >/dev/null 2>&1 && pdfforge-cli run-script || go run github.com/rendis/pdf-forge/cmd/pdfforge-cli run-script
endif

## help: Show this help
help:
	@echo "Usage: make <target>"
	@echo ""
	@echo "Quick start:"
	@echo "  fresh     Full reset: check prereqs, clean DB, start PG, build and run"
	@echo "  check     Verify prerequisites (Docker, Typst, Go)"
	@echo ""
	@echo "Docker:"
	@echo "  up        Start app + PostgreSQL (full containerized)"
	@echo "  up-db     Start only PostgreSQL (for local dev)"
	@echo "  down      Stop all containers"
	@echo "  logs      Tail container logs"
	@echo "  clean     Stop containers, remove volumes"
	@echo ""
	@echo "Local development:"
	@echo "  build     Build the Go binary"
	@echo "  run       Build and run locally"
	@echo "  migrate   Apply database migrations"
	@echo "  dev       Run with hot reload (requires air)"
	@echo "  test      Run tests"
	@echo "  fmt       Format Go source files"
	@echo "  lint      Run linter (requires golangci-lint)"
	@echo ""
	@echo "Scripts:"
	@echo "  run-script         Interactive script selector"
	@echo "  run-script <name>  Run a script directly"
	@echo ""
	@echo "Configuration:"
	@echo "  PG_PORT=5433 make up    Use custom PostgreSQL port (default: 5432)"
	@echo "  ENV=.env.prod make run  Load specific .env file (skip prompt)"
	@echo "  Copy .env.example to .env to customize settings"
