import{ac as H,r,j as e,A as L,m as N,e as $,L as W,ad as Z}from"./index-YYj3FBXU.js";import{C as G,a as P,c as ee,u as te,d as re,R as se,S as ne,L as ae,b as oe}from"./document-import-DccZ4080.js";import{u as O,e as ie}from"./dropdown-menu-C_J-baFS.js";import{F as ce}from"./file-text-CtBgfFAt.js";import{B as A}from"./button-C9nqbCQ8.js";import{C as J}from"./circle-alert-CFFMVTfk.js";import{v as Y}from"./templates-api-BdHVZpaH.js";import"./page-transition-store-C6ImOhzY.js";import"./dialog-CB29n4bA.js";import{A as ue}from"./arrow-left-DHFUxBhJ.js";import"./index-BcOId7RC.js";import"./label-D2hUiCZL.js";import"./scroll-area-NqJ9EUdn.js";import"./index-BdQq_4o_.js";import"./select-zYfuzTLL.js";import"./index-DVSht-Hx.js";import"./chevron-down-B01Hsu-s.js";import"./badge-BuofeXAo.js";import"./index-BZogh0PE.js";import"./chevron-left-CWDq_ORR.js";import"./plus-Db3KDbnG.js";import"./trash-2-CIUC_3ja.js";import"./list-CynRbO5M.js";import"./ellipsis-BZR-ZpiN.js";import"./send-DyI9-4be.js";import"./square-check-big-D_Per2i9.js";import"./variable-Dtxt5UXL.js";import"./search-BTwE1IOs.js";import"./arrow-right-BVlOrhfw.js";import"./layers-E_eJeLvN.js";import"./i18n-U0oMc166.js";import"./clock-Dvv5EjJf.js";import"./folder-open-DekSbdqC.js";import"./power-Dzw7xQJK.js";import"./square-pen-HMqR_v88.js";import"./trash-6czKAp0V.js";function le(t,n){if(t===void 0)return{shouldBlockFn:()=>!0,withResolver:!1};if("shouldBlockFn"in t)return t;if(typeof t=="function")return{shouldBlockFn:async()=>await t(),enableBeforeUnload:!0,withResolver:!1};const o=!!(t.condition??!0),i=t.blockerFn;return{shouldBlockFn:async()=>o&&i!==void 0?await i():o,enableBeforeUnload:o,withResolver:i===void 0}}function de(t,n){const{shouldBlockFn:o,enableBeforeUnload:i=!0,disabled:a=!1,withResolver:s=!1}=le(t),u=H(),{history:d}=u,[S,g]=r.useState({status:"idle",current:void 0,next:void 0,action:void 0,proceed:void 0,reset:void 0});return r.useEffect(()=>{const c=async v=>{function j(x){const w=u.parseLocation(x),h=u.getMatchedRoutes(w.pathname);return h.foundRoute===void 0?{routeId:"__notFound__",fullPath:w.pathname,pathname:w.pathname,params:h.routeParams,search:u.options.parseSearch(x.search)}:{routeId:h.foundRoute.id,fullPath:h.foundRoute.fullPath,pathname:w.pathname,params:h.routeParams,search:u.options.parseSearch(x.search)}}const b=j(v.currentLocation),l=j(v.nextLocation);if(b.routeId==="__notFound__"&&l.routeId!=="__notFound__")return!1;const p=await o({action:v.action,current:b,next:l});if(!s)return p;if(!p)return!1;const y=await new Promise(x=>{g({status:"blocked",current:b,next:l,action:v.action,proceed:()=>x(!1),reset:()=>x(!0)})});return g({status:"idle",current:void 0,next:void 0,action:void 0,proceed:void 0,reset:void 0}),y};return a?void 0:d.block({blockerFn:c,enableBeforeUnload:i})},[o,i,a,s,d,u]),S}function me(t){return t?t.status==="PUBLISHED"?"PUBLISHED":t.status==="ARCHIVED"?"ARCHIVED":t.scheduledPublishAt?"SCHEDULED":"DRAFT":"DRAFT"}function fe(t){return me(t)==="DRAFT"}function pe({isVisible:t,documentName:n}){const{t:o}=O();return e.jsx(L,{children:t&&e.jsx(N.div,{initial:{opacity:1},exit:{opacity:0},transition:{duration:.4,ease:"easeOut"},className:"fixed inset-0 z-50 flex items-center justify-center bg-background",children:e.jsxs(N.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.3,ease:"easeOut"},className:"flex flex-col items-center gap-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx(N.div,{animate:{scale:[1,1.15,1],opacity:[.12,.04,.12]},transition:{duration:2.5,repeat:1/0,ease:"easeInOut"},className:"absolute inset-0 rounded-2xl bg-muted-foreground",style:{margin:"-16px"}}),e.jsx("div",{className:"relative flex h-14 w-14 items-center justify-center rounded-xl bg-secondary border border-border shadow-sm",children:e.jsx(ce,{className:"h-6 w-6 text-muted-foreground"})})]}),e.jsxs("div",{className:"flex flex-col items-center gap-2 text-center min-h-[52px]",children:[e.jsx("h2",{className:"text-base font-medium text-foreground",children:o("editor.preparation.title","Preparando documento")}),n&&e.jsx("p",{className:"text-sm text-muted-foreground max-w-[280px] truncate",children:n})]}),e.jsx("div",{className:"h-0.5 w-32 overflow-hidden rounded-full bg-border",children:e.jsx(N.div,{animate:{x:["-100%","100%"]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"},className:"h-full w-1/2 rounded-full bg-muted-foreground/50"})})]})})})}function xe(t,n){const i=new Date().getTime()-t.getTime(),a=Math.floor(i/1e3),s=Math.floor(a/60);return a<5?n("editor.autoSave.justNow")||"ahora mismo":a<60?n("editor.autoSave.secondsAgo",{count:a})||`hace ${a}s`:s<60?n("editor.autoSave.minutesAgo",{count:s})||`hace ${s}m`:t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}const he=[.4,0,.2,1],ge=[.4,0,1,1],ve={initial:{opacity:0,x:30,filter:"blur(4px)"},animate:{opacity:1,x:0,filter:"blur(0px)",transition:{duration:.5,ease:he}},exit:{opacity:0,x:30,filter:"blur(4px)",transition:{duration:.4,ease:ge}}},ye={type:"spring",stiffness:150,damping:20,duration:.6},Se=[.34,1.56,.64,1],je=[.4,0,1,1],be={initial:{scale:.5,opacity:0},animate:{scale:1,opacity:1,transition:{duration:.4,ease:Se}},exit:{scale:.5,opacity:0,transition:{duration:.25,ease:je}}};function we({status:t}){const n={idle:e.jsx(G,{className:"h-4 w-4 text-muted-foreground"}),pending:e.jsx(G,{className:"h-4 w-4 text-muted-foreground"}),saving:e.jsx(W,{className:"h-4 w-4 text-primary animate-spin"}),saved:e.jsx(ie,{className:"h-4 w-4 text-green-600 dark:text-green-500"}),error:e.jsx(J,{className:"h-4 w-4 text-destructive"})};return e.jsx(N.div,{layoutId:"save-status-icon",className:"flex items-center justify-center w-5 h-5",transition:ye,children:e.jsx(L,{mode:"wait",children:e.jsx(N.div,{variants:be,initial:"initial",animate:"animate",exit:"exit",children:n[t]},t)})})}function Re({status:t,lastSavedAt:n,error:o,onRetry:i,className:a}){const{t:s}=O(),u=()=>{switch(t){case"idle":return n?`${s("editor.autoSave.saved")||"Guardado"} ${xe(n,s)}`:null;case"pending":return s("editor.autoSave.pending")||"Sin guardar...";case"saving":return s("editor.autoSave.saving")||"Guardando...";case"saved":return s("editor.autoSave.saved")||"Guardado";case"error":return s("editor.autoSave.error")||"Error al guardar";default:return null}},d=()=>{switch(t){case"idle":case"pending":return"text-muted-foreground";case"saving":return"text-primary";case"saved":return"text-green-600 dark:text-green-500";case"error":return"text-destructive";default:return"text-muted-foreground"}},S=u();return e.jsxs(N.div,{layout:!0,className:$("flex items-center gap-2 text-xs h-5 min-w-[120px] justify-end overflow-hidden",t==="idle"&&"opacity-60",a),children:[e.jsx(L,{mode:"wait",children:S&&e.jsx(N.span,{className:$("whitespace-nowrap",d()),variants:ve,initial:"initial",animate:"animate",exit:"exit",children:S},`${t}-${S}`)}),e.jsx(we,{status:t}),e.jsx(L,{children:t==="error"&&i&&e.jsx(N.div,{initial:{opacity:0,scale:.8,x:20},animate:{opacity:1,scale:1,x:0},exit:{opacity:0,scale:.8,x:20},transition:{duration:.3,ease:"easeOut"},children:e.jsx(A,{variant:"ghost",size:"sm",className:"h-5 px-1.5 text-xs text-destructive hover:text-destructive",onClick:i,children:s("common.retry")||"Reintentar"})})})]})}const Ne=2e3,Ee=2,ke=3e3;function Ie({editor:t,templateId:n,versionId:o,enabled:i,debounceMs:a=Ne,meta:s}){const[u,d]=r.useState("idle"),[S,g]=r.useState(null),[c,v]=r.useState(null),[j,b]=r.useState(!1),l=r.useRef(null),p=r.useRef(null),E=r.useRef(0),y=r.useRef(!1),x=P(m=>m.pageSize),w=P(m=>m.margins),h=r.useMemo(()=>({pageSize:x,margins:w}),[x,w]);r.useEffect(()=>()=>{l.current&&clearTimeout(l.current),p.current&&clearTimeout(p.current)},[]);const C=r.useCallback(async()=>{if(!(!t||!i||y.current)){y.current=!0,d("saving"),v(null);try{const m={title:(s==null?void 0:s.title)||"Untitled",description:s==null?void 0:s.description,language:(s==null?void 0:s.language)||"es",customFields:s==null?void 0:s.customFields},k=ee(t,{pagination:h},m,{includeChecksum:!0});await Y.update(n,o,{contentStructure:k}),d("saved"),g(new Date),b(!1),E.current=0,p.current&&clearTimeout(p.current),p.current=setTimeout(()=>{d("idle")},ke)}catch(m){const F=m instanceof Error?m:new Error("Save failed");if(E.current<Ee){E.current++,y.current=!1,setTimeout(()=>C(),1e3);return}d("error"),v(F),E.current=0}finally{y.current=!1}}},[t,i,n,o,s,h]),D=r.useCallback(async()=>{l.current&&(clearTimeout(l.current),l.current=null),await C()},[C]),M=r.useCallback(()=>{v(null),d(j?"pending":"idle")},[j]),B=r.useCallback(()=>{i&&(b(!0),d("pending"),l.current&&clearTimeout(l.current),l.current=setTimeout(()=>{l.current=null,C()},a))},[i,a,C]);return r.useEffect(()=>{if(!t||!i)return;const m=()=>{B()};return t.on("update",m),()=>{t.off("update",m)}},[t,i,B]),{status:u,lastSavedAt:S,error:c,isDirty:j,save:D,resetError:M}}function Ce({isDirty:t,status:n,save:o,enabled:i=!0}){const a=r.useRef(!1),s=t||n==="pending",u=r.useCallback(async()=>{if(!s||a.current)return!1;a.current=!0;try{await o()}catch(d){console.warn("Failed to save on navigation:",d)}finally{a.current=!1}return!1},[s,o]);de({shouldBlockFn:u,disabled:!i,enableBeforeUnload:i&&s})}function ft(){const{workspaceId:t,templateId:n,versionId:o}=Z.useParams(),i=H(),{t:a}=O(),{variables:s}=te(),u=r.useRef(null),[d,S]=r.useState(null),g=r.useRef(!1),[c,v]=r.useState(null),[j,b]=r.useState(!0),[l,p]=r.useState(null),[E,y]=r.useState(null),[x,w]=r.useState(!0),[h,C]=r.useState(!1),[D,M]=r.useState(!1);r.useRef(Date.now());const B=r.useRef(!1),m=r.useRef(null),F=r.useCallback(async()=>{b(!0),p(null),y(null),g.current=!1;try{const f=await Y.get(n,o);v(f)}catch(f){console.error("Failed to fetch version:",f),p(f instanceof Error?f:new Error("Failed to load version"))}finally{b(!1)}},[n,o]);r.useEffect(()=>{const f=`${n}:${o}`;B.current&&m.current===f||(B.current=!0,m.current=f,F())},[F,n,o]);const k=fe(c);r.useEffect(()=>{if(!u.current||!c||g.current)return;const f=u.current;if(!(c.contentStructure&&Object.keys(c.contentStructure).length>0)){g.current=!0;return}const Q={setPaginationConfig:I=>{const{pageSize:_,margins:z}=I;_&&P.getState().setPageSize(_),z&&P.getState().setMargins(z)}},V=c.contentStructure,T=re(V,f,Q,s.map(I=>({id:I.id,variableId:I.variableId,type:I.type,label:I.label})));if(!T.success){const I=T.validation.errors.map(_=>_.message).join(", ");y(I||a("editor.errors.importFailed")),console.error("Import failed:",T.validation.errors),console.error("Import failed - Full errors:",JSON.stringify(T.validation.errors,null,2)),console.error("Import failed - Document:",JSON.stringify(V,null,2))}g.current=!0},[c,u.current,s]);const R=Ie({editor:d,templateId:n,versionId:o,enabled:k&&g.current,debounceMs:2e3,meta:{title:(c==null?void 0:c.name)||a("editor.document"),language:"es"}});Ce({isDirty:R.isDirty,status:R.status,save:R.save,enabled:k});const U=r.useCallback(async()=>{await R.save()},[R]),q=2e3;r.useEffect(()=>{const f=setTimeout(()=>{M(!0)},q);return()=>clearTimeout(f)},[]),r.useEffect(()=>{h&&D&&requestAnimationFrame(()=>{w(!1)})},[h,D]);const K=r.useCallback(()=>{C(!0)},[]);if(l||E)return e.jsxs("div",{className:"flex flex-col h-full bg-background items-center justify-center",children:[e.jsx(J,{className:"h-8 w-8 text-destructive"}),e.jsx("p",{className:"mt-4 text-sm text-destructive",children:(l==null?void 0:l.message)||E||a("editor.errors.versionLoadFailed")}),e.jsxs(A,{variant:"outline",size:"sm",className:"mt-4",onClick:()=>{y(null),F()},children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),a("common.retry")||"Reintentar"]})]});const X=j||x;return e.jsxs(e.Fragment,{children:[e.jsx(pe,{isVisible:X,documentName:c==null?void 0:c.name}),e.jsxs("div",{className:"flex flex-col h-[calc(100vh-4rem)]",children:[e.jsxs("header",{className:"flex items-center justify-between px-4 py-2 border-b bg-card",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(A,{variant:"ghost",size:"icon",onClick:()=>i.history.back(),children:e.jsx(ue,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-sm font-semibold",children:(c==null?void 0:c.name)||"Editor"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:["v",(c==null?void 0:c.versionNumber)||o]}),k&&e.jsx("span",{className:"text-[10px] bg-primary/10 text-primary px-1.5 py-0.5 rounded",children:a("editor.status.editable")})]})]})]}),e.jsx("div",{className:"flex items-center gap-3",children:k&&e.jsxs(e.Fragment,{children:[e.jsx(Re,{status:R.status,lastSavedAt:R.lastSavedAt,error:R.error,onRetry:U}),e.jsxs(A,{size:"sm",variant:"outline",onClick:U,disabled:R.status==="saving",children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),a("common.save")||"Guardar"]})]})})]}),!k&&e.jsxs("div",{className:"flex items-center justify-center gap-2 px-4 py-2 bg-warning-muted border-b border-warning-border",children:[e.jsx(ae,{className:"h-4 w-4 text-warning-foreground"}),e.jsx("span",{className:"text-sm font-medium text-warning-foreground",children:a("editor.status.readOnlyBanner")})]}),e.jsx("div",{className:"flex-1 overflow-hidden",children:!j&&e.jsx(oe,{initialContent:"",editable:k,variables:s,editorRef:u,onEditorReady:S,onFullyReady:K,templateId:n,versionId:o},"editor")})]})]})}export{ft as component};
