# Generated by pdfforge-cli init for project "pdftest".
# pdf-forge: https://github.com/rendis/pdf-forge

.PHONY: up up-db down build run migrate logs clean dev test fmt lint help

# Load .env if exists
-include .env
export

# Resolve PostgreSQL port:
# 1. PG_PORT env/arg if set explicitly
# 2. Port from running container (for "make run" after "make up-db")
# 3. First free port from 5432-5434 (for starting new container)
RESOLVED_PG_PORT := $(or $(PG_PORT),$(shell \
  docker port pdftest-postgres-1 5432 2>/dev/null | head -1 | grep -o '[0-9]*$$' || \
  ( for p in 5432 5433 5434; do \
      if ! lsof -iTCP:$$p -sTCP:LISTEN -t >/dev/null 2>&1; then echo $$p; exit 0; fi; \
    done; echo 5432 ) ))

## up: Start app + PostgreSQL (full containerized)
up:
	@echo "» PostgreSQL port: $(RESOLVED_PG_PORT)"
	PG_PORT=$(RESOLVED_PG_PORT) docker compose up --build -d

## up-db: Start only PostgreSQL
up-db:
	@echo "» PostgreSQL port: $(RESOLVED_PG_PORT)"
	PG_PORT=$(RESOLVED_PG_PORT) docker compose up postgres -d

## down: Stop all containers
down:
	docker compose down

## logs: Tail container logs
logs:
	docker compose logs -f

## clean: Stop containers, remove volumes
clean:
	docker compose down -v

# Local development

## build: Build the Go binary
build:
	go build -o bin/app .

## run: Build and run locally (requires PG running)
run: build
	DOC_ENGINE_DATABASE_PORT=$(RESOLVED_PG_PORT) ./bin/app

## migrate: Apply database migrations
migrate:
	@command -v pdfforge-cli >/dev/null 2>&1 && pdfforge-cli migrate || go run github.com/rendis/pdf-forge/cmd/pdfforge-cli migrate

## dev: Run with hot reload (requires air: go install github.com/air-verse/air@latest)
dev:
	air

## test: Run tests
test:
	go test -race ./...

## fmt: Format Go source files
fmt:
	gofmt -w .

## lint: Run linter (requires golangci-lint)
lint:
	golangci-lint run ./...

## help: Show this help
help:
	@echo "Usage: make <target>"
	@echo ""
	@echo "Docker:"
	@echo "  up        Start app + PostgreSQL (full containerized)"
	@echo "  up-db     Start only PostgreSQL (for local dev)"
	@echo "  down      Stop all containers"
	@echo "  logs      Tail container logs"
	@echo "  clean     Stop containers, remove volumes"
	@echo ""
	@echo "Local development:"
	@echo "  build     Build the Go binary"
	@echo "  run       Build and run locally"
	@echo "  migrate   Apply database migrations"
	@echo "  dev       Run with hot reload (requires air)"
	@echo "  test      Run tests"
	@echo "  fmt       Format Go source files"
	@echo "  lint      Run linter (requires golangci-lint)"
	@echo ""
	@echo "Configuration:"
	@echo "  PG_PORT=5433 make up    Use custom PostgreSQL port (auto-detected: $(RESOLVED_PG_PORT))"
	@echo "  Copy .env.example to .env to customize settings"
