# Generated by pdfforge-cli init for project "test-scaffold".
# pdf-forge: https://github.com/rendis/pdf-forge

# ---- Build stage ----
FROM golang:1.25-alpine AS builder
RUN apk add --no-cache git
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 go build -o /bin/app .

# ---- Runtime stage ----
FROM alpine:3.21
RUN apk add --no-cache ca-certificates curl xz

# Install Typst (auto-detect architecture: x86_64 / aarch64)
ARG TYPST_VERSION=latest
RUN ARCH=$(uname -m) && \
    case "$ARCH" in \
      x86_64)  TYPST_ARCH="x86_64-unknown-linux-musl" ;; \
      aarch64) TYPST_ARCH="aarch64-unknown-linux-musl" ;; \
      *)       echo "Unsupported architecture: $ARCH" && exit 1 ;; \
    esac && \
    curl -fsSL "https://github.com/typst/typst/releases/${TYPST_VERSION}/download/typst-${TYPST_ARCH}.tar.xz" \
      | tar xJ --strip-components=1 -C /usr/local/bin/ && \
    typst --version

COPY --from=builder /bin/app /bin/app
COPY config/ /app/config/
WORKDIR /app
EXPOSE 8080
CMD ["/bin/app"]
